<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Terminplaner – Freundlich & Mobil</title>
  <style>
    :root {
      --bg: #f6f8fb;
      --card: #ffffff;
      --accent: #2563eb;
      --muted: #6b7280;
      --danger: #e11d48;
      --border: #e6e9ef;
      --radius: 12px;
      --shadow: 0 6px 20px rgba(16,24,40,0.06);
      --reminder-bg: #fff7cc;
      --reminder-border: #ffd24d;
      --field-width: 260px; /* einheitliche Breite aller Eingabefelder / Selects */
    }

    /* Grundlayout */
    body {
      margin: 0;
      padding: 1rem;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: var(--bg);
      color: #111827;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
    }

    h1 {
      font-size: 1.5rem;
      margin-bottom: 1rem;
      text-align: center;
      color: #0f172a;
    }

    .layout {
      display: grid;
      grid-template-columns: 1fr 420px;
      gap: 1rem;
    }

    @media (max-width: 980px) {
      .layout { grid-template-columns: 1fr; }
    }

    .card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 1rem;
    }

    /* Formular - einspaltig mit einheitlicher Feldbreite */
    form {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .label {
      display: block;
      font-size: 0.9rem;
      color: var(--muted);
      margin-bottom: 6px;
      margin-top: 0.6rem;
      font-weight: 600;
    }

    input, select, textarea {
      width: var(--field-width);
      max-width: 100%;
      padding: 0.55rem 0.7rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 1rem;
      box-sizing: border-box;
      background: #fbfdff;
      transition: box-shadow .15s ease, border-color .15s ease;
    }

    /* Fokus-Rahmen */
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: rgba(37,99,235,0.35);
      box-shadow: 0 0 0 4px rgba(37,99,235,0.06);
      background: #fff;
    }

    /* Action-Buttons */
    .actions {
      display: flex;
      gap: 0.6rem;
      margin-top: 1rem;
      flex-wrap: wrap;
    }

    button {
      border: 0;
      border-radius: 8px;
      padding: 0.5rem 0.85rem;
      font-size: 0.95rem;
      cursor: pointer;
      font-weight: 700;
    }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-primary:hover { filter: brightness(.95); }
    .btn-ghost { background: #f3f4f6; color: #0f172a; }
    .btn-ghost:hover { filter: brightness(.98); }
    .btn-danger { background: var(--danger); color: #fff; }
    .btn-danger:hover { filter: brightness(.95); }

    .hr { height: 1px; background: var(--border); margin: 0.9rem 0; width: 100%; }

    .pill {
      display: inline-block;
      background: #eef2ff;
      color: #1e3a8a;
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      font-weight: 700;
      font-size: 0.86rem;
      margin-top: 0.6rem;
    }

    /* Terminliste */
    .list-title {
      margin: 0.9rem 0 0.4rem;
      font-weight: 800;
      color: #0f172a;
      font-size: 1rem;
      border-bottom: 1px solid transparent;
      padding-bottom: 6px;
    }

    .apt-card {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 0.8rem;
      margin-bottom: 0.6rem;
      box-shadow: 0 4px 12px rgba(16,24,40,0.03);
      transition: transform .12s ease;
    }
    .apt-card:hover { transform: translateY(-3px); }

    .apt-top {
      display:flex;
      justify-content:space-between;
      gap:0.6rem;
      align-items:flex-start;
      flex-wrap:wrap;
    }

    .apt-name { font-weight:800; color:#0f172a; font-size:1rem; }
    .apt-time { font-size:0.95rem; color:var(--muted); text-align:right; }

    .apt-meta { margin-top:0.45rem; display:flex; gap:0.6rem; flex-wrap:wrap; color:#263238; }
    .meta-pill { background:#f1f5f9; padding:.25rem .6rem; border-radius:8px; font-weight:700; }

    .apt-notes { margin-top:0.5rem; color:var(--muted); font-size:0.9rem; }
    .apt-actions { display:flex; gap:.4rem; margin-top:.6rem; justify-content:flex-end; }

    .small { font-size:.85rem; color:var(--muted); }

    /* Reminder Banner */
    #reminderBanner {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 1rem;
      background: var(--reminder-bg);
      border: 1px solid var(--reminder-border);
      padding: 0.9rem 1rem;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(16,24,40,0.12);
      display: none;
      z-index: 9999;
      font-weight: 800;
      color: #1f2937;
      max-width: 92%;
      align-items: center;
      justify-content: space-between;
      gap: 0.8rem;
    }
    #reminderBanner.show { display:flex; animation: pulse 1.4s ease-in-out infinite; }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 rgba(255,210,77,0.08); }
      50% { box-shadow: 0 12px 30px rgba(255,210,77,0.18); }
      100% { box-shadow: 0 0 0 rgba(255,210,77,0.08); }
    }

    /* responsive: auf kleinen Bildschirmen volle Breite der Felder */
    @media (max-width: 600px) {
      input, select, textarea { width: 100%; }
      .layout { gap: 0.8rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Terminannahme</h1>

    <div class="layout">
      <!-- Formular -->
      <div class="card">
        <div style="font-weight:800;margin-bottom:.6rem">Neuen Termin anlegen</div>
        <form id="aptForm" onsubmit="Planner.saveAppointment(event)">
          <input type="hidden" id="editId" />

          <label class="label" for="name">Name</label>
          <input id="name" list="nameList" required />
          <datalist id="nameList"></datalist>

          <label class="label" for="phone">Telefonnummer (optional)</label>
          <input id="phone" type="tel" />

          <label class="label" for="date">Datum</label>
          <input id="date" type="text" placeholder="bitte auswählen" required
                 onfocus="(this.type='date')" onblur="if(!this.value)this.type='text'" />

          <label class="label" for="time">Uhrzeit</label>
          <input id="time" type="time" required />

          <label class="label" for="persons">Personenanzahl</label>
          <select id="persons" required>
            <option value="">Bitte auswählen</option>
            <option>1</option><option>2</option><option>3</option><option>4</option>
            <option>5</option><option>6</option><option>7</option><option>8</option>
          </select>

          <label class="label" for="payment">Zahlungsart</label>
          <select id="payment" required>
            <option value="">Bitte auswählen</option>
            <option>Bar</option><option>EC</option><option>Rechnung</option><option>Transportschein</option>
          </select>

          <label class="label" for="notes">Anmerkungen</label>
          <textarea id="notes" rows="3"></textarea>

          <div class="hr"></div>

          <div class="pill">Startadresse</div>
          <input id="startAddr" type="text" />

          <div class="pill" style="margin-top:.6rem">Zieladresse</div>
          <input id="zielAddr" type="text" />

          <div class="actions">
            <button class="btn-primary" type="submit">Speichern</button>
            <button class="btn-ghost" type="button" onclick="Planner.resetForm()">Zurücksetzen</button>
            <button class="btn-danger" type="button" onclick="Planner.clearAll()">Alle löschen</button>
          </div>
        </form>
      </div>

      <!-- Terminliste -->
      <div class="card">
        <div style="font-weight:800;margin-bottom:.5rem">Terminliste</div>
        <div id="aptList"></div>
        <div id="counter" style="margin-top:.6rem;color:var(--muted);font-size:.9rem">0 Termine</div>
      </div>
    </div>
  </div>

  <div id="reminderBanner" role="status" aria-live="polite"></div>

  <script>
    const STORAGE = { names: 'planner_names_v4', apts: 'planner_apts_v4' };
    const $ = (s, r = document) => r.querySelector(s);

    const Planner = {
      state: { names: [], apts: [] },
      reminderInterval: null,
      notifRequested: false,
      activeReminder: null,

      init() {
        this.state.names = this._load(STORAGE.names, []);
        this.state.apts = this._load(STORAGE.apts, []);
        this._refreshNameList();
        this._renderList();
        this.checkReminders();
        this.reminderInterval = setInterval(() => this.checkReminders(), 30000);
      },

      _load(key, fallback) {
        try { return JSON.parse(localStorage.getItem(key)) ?? fallback; } catch { return fallback; }
      },
      _save(key, value) { localStorage.setItem(key, JSON.stringify(value)); },

      _refreshNameList() {
        $('#nameList').innerHTML = this.state.names.map(n => `<option value="${this._esc(n)}">`).join('');
      },

      saveAppointment(e) {
        e.preventDefault();
        const name = $('#name').value.trim();
        if (!name) return alert("Name fehlt");

        const apt = {
          id: $('#editId').value || Date.now(),
          name,
          phone: $('#phone').value.trim(),
          date: $('#date').value,
          time: $('#time').value,
          persons: $('#persons').value,
          payment: $('#payment').value,
          notes: $('#notes').value,
          startAddr: $('#startAddr').value,
          zielAddr: $('#zielAddr').value,
          reminded: false
        };

        if (!this.state.names.includes(name)) {
          this.state.names.push(name);
          this.state.names.sort();
          this._save(STORAGE.names, this.state.names);
          this._refreshNameList();
        }

        const idx = this.state.apts.findIndex(a => a.id == apt.id);
        if (idx >= 0) this.state.apts[idx] = apt;
        else this.state.apts.push(apt);

        this.state.apts.sort((a, b) => this._dt(a) - this._dt(b));
        this._save(STORAGE.apts, this.state.apts);
        this._renderList();
        this.resetForm();
        this.checkReminders();
      },

      _renderList() {
        const container = $('#aptList');
        if (!this.state.apts.length) {
          container.innerHTML = "<div style='color:var(--muted);padding:.6rem'>Keine Termine</div>";
          $('#counter').textContent = "0 Termine";
          return;
        }

        const groups = { heute: [], morgen: [], spaeter: [] };
        const now = new Date();
        const todayStr = now.toISOString().slice(0, 10);
        const tomorrow = new Date(now); tomorrow.setDate(now.getDate() + 1);
        const tomorrowStr = tomorrow.toISOString().slice(0, 10);

        for (const a of this.state.apts) {
          if (a.date === todayStr) groups.heute.push(a);
          else if (a.date === tomorrowStr) groups.morgen.push(a);
          else groups.spaeter.push(a);
        }

        let html = "";
        const renderGroup = (title, arr) => {
          if (arr.length) {
            html += `<div class="list-title">${title}</div>`;
            html += arr.map(a => this._aptCard(a)).join('');
          }
        };

        renderGroup("Heute", groups.heute);
        renderGroup("Morgen", groups.morgen);
        renderGroup("Später", groups.spaeter);

        container.innerHTML = html;
        $('#counter').textContent = `${this.state.apts.length} Termin(e)`;
      },

      _aptCard(a) {
        const dt = this._dt(a);
        const dateStr = dt ? dt.toLocaleDateString("de-DE") : a.date;
        const time = a.time || "";
        return `<div class="apt-card">
          <div class="apt-top">
            <div>
              <div class="apt-name">${this._esc(a.name)}</div>
              <div class="small">${this._esc(a.phone || "")}</div>
            </div>
            <div class="apt-time">${dateStr}<br>${time}</div>
          </div>
          <div class="apt-meta">
            <div class="meta-pill">Pers: ${this._esc(a.persons || "-")}</div>
            <div class="meta-pill">Zahlung: ${this._esc(a.payment || "-")}</div>
          </div>
          <div class="apt-notes">${this._esc(a.notes || "")}</div>
          <div style="margin-top:.3rem;font-size:.9rem;color:var(--muted)">${this._esc(a.startAddr || "-")} → ${this._esc(a.zielAddr || "-")}</div>
          <div class="apt-actions">
            <button class="btn-ghost" onclick="Planner.edit(${a.id})">Bearbeiten</button>
            <button class="btn-danger" onclick="Planner.del(${a.id})">Löschen</button>
          </div>
        </div>`;
      },

      edit(id) {
        const a = this.state.apts.find(x => x.id == id);
        if (!a) return;
        $('#editId').value = a.id;
        $('#name').value = a.name;
        $('#phone').value = a.phone;
        $('#date').value = a.date;
        $('#time').value = a.time;
        $('#persons').value = a.persons;
        $('#payment').value = a.payment;
        $('#notes').value = a.notes;
        $('#startAddr').value = a.startAddr;
        $('#zielAddr').value = a.zielAddr;
        window.scrollTo({ top: 0, behavior: "smooth" });
      },

      del(id) {
        if (!confirm("Diesen Termin löschen?")) return;
        this.state.apts = this.state.apts.filter(a => a.id != id);
        this._save(STORAGE.apts, this.state.apts);
        this._renderList();
      },

      clearAll() {
        if (!confirm("Alle Termine löschen?")) return;
        this.state.apts = [];
        this._save(STORAGE.apts, []);
        this._renderList();
      },

      resetForm() {
        $('#aptForm').reset();
        $('#editId').value = "";
      },

      checkReminders() {
        const now = Date.now();
        for (const a of this.state.apts) {
          if (a.reminded) continue;
          if (!a.date || !a.time) continue;
          const t = this._dt(a).getTime();
          const remindAt = t - 30 * 60 * 1000; // 30 Minuten vorher
          if (now >= remindAt && now < t) {
            a.reminded = true;
            this._save(STORAGE.apts, this.state.apts);
            this._triggerReminder(a);
          }
        }
      },

      _triggerReminder(a) {
        const when = a.date + " " + (a.time || "");
        const msg = `${a.name} — ${when}`;
        this._showBanner(msg);
        this._startAlarm();

        if ("Notification" in window) {
          if (Notification.permission === "granted") {
            try { new Notification("Erinnerung", { body: msg }); } catch (err) { /* ignore */ }
          } else if (!this.notifRequested) {
            // Anfrage nur einmal stellen
            this.notifRequested = true;
            Notification.requestPermission().then(p => {
              if (p === "granted") {
                try { new Notification("Erinnerung", { body: msg }); } catch (err) { /* ignore */ }
              }
            }).catch(()=>{/* ignore */});
          }
        }
      },

      _showBanner(msg) {
        const b = $('#reminderBanner');
        b.innerHTML = `${this._esc(msg)} <button class="btn-primary" onclick="Planner._confirmReminder()">OK</button>`;
        b.classList.add("show");
      },

      _confirmReminder() {
        const b = $('#reminderBanner');
        b.classList.remove("show");
        this._stopAlarm();
      },

      _startAlarm() {
        if (this.activeReminder) return;
        this.activeReminder = setInterval(() => this._beep(), 3000);
        this._beep();
      },

      _stopAlarm() {
        if (!this.activeReminder) return;
        clearInterval(this.activeReminder);
        this.activeReminder = null;
      },

      _beep() {
        try {
          const Ctx = window.AudioContext || window.webkitAudioContext;
          const ctx = new Ctx();
          const osc = ctx.createOscillator();
          const g = ctx.createGain();
          osc.frequency.value = 880;
          osc.type = "sine";
          osc.connect(g);
          g.connect(ctx.destination);
          g.gain.setValueAtTime(0.0001, ctx.currentTime);
          osc.start();
          g.gain.linearRampToValueAtTime(0.25, ctx.currentTime + 0.01);
          g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.45);
          osc.stop(ctx.currentTime + 0.5);
          setTimeout(() => {
            try { ctx.close(); } catch (e) {}
          }, 700);
        } catch (err) {
          // AudioContext kann in manchen Umgebungen blockiert sein
          console.warn("Beep nicht möglich:", err);
        }
      },

      _dt(a) {
        if (!a || !a.date) return new Date(8640000000000000); // sehr weit in der Zukunft, damit sort() nicht fails
        const [y, m, d] = a.date.split("-").map(Number);
        const [hh, mm] = (a.time || "00:00").split(":").map(Number);
        return new Date(y, (m || 1) - 1, d || 1, hh || 0, mm || 0);
      },

      _esc(s) {
        return String(s || "").replace(/[&<>"']/g, m => ({
          "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
        }[m]));
      }
    };

    window.addEventListener("load", () => Planner.init());
  </script>
</body>
</html>
